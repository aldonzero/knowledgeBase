### RPC （Remote Procedure Call）远程过程调用

#### 概念

允许程序远程调用过程或函数，不用程序员显示编码远程调用这个环节。通俗讲，就是程序员知道有一个程序接口直接用，而不考虑其他（包括是不是在本地，网络限制等各种因素），直接将远程当作本地使用。

#### 特点

- 简单：语义清晰，使得分布式计算更容易
- 高效：使分布式中远程简单高效
- 通用：能够跨平台

#### 分类

- 同步调用
  客户方等待调用执行并返回结果

- 异步调用

  客户方调用后不用等待执行结构返回，但依然可以通过回调通等方式返回结果

#### 组件职责

- RpcServer
  负责导出（export）远程接口

- RpcClient

  导入（import）远程接口代理

- RpcInvoker

  客户方实现：负责发送调用信息到服务方，并返回调用结果

  服务方实现：负责服务端接口的具体实现并返回调用结果

- RpcProtocol

  负责协议编码/解码，客户代理在发起调用前需要对调用信息进行编码

  - 编码信息越少越好，传输数据少
  - 规则越简单越好，执行效率高

  ```matlab
  --调用编码
  1. 接口方法
  	接口名、方法名
  2. 方法参数
  	参数类型、参数值
  3. 调用属性
  	调用附件隐式参数、调用超时时间
  --返回编码 --
  1. 返回结果
  	接口方法中定义的返回值
  2. 返回码
  	异常返回码
  3. 返回异常信息
  	调用异常信息
  
  --预留扩展信息 --
  1. 元信息
  2. 调用必要信息
  ```

  RPC协议结构设计

  ```yaml
  --消息头--
  magic      : 协议魔数，为解码设计
  header size: 协议头长度，为扩展设计
  version    : 协议版本，为兼容设计
  st         : 消息体序列化类型
  hb         : 心跳消息标记，为长连接传输层心跳设计
  ow         : 单向消息标记，
  rp         : 响应消息标记，不置位默认是请求消息
  status code: 响应消息状态码
  reserved   : 为字节对齐保留
  message id : 消息 id
  body size  : 消息体长度
  
  -- 消息体 --
  采用序列化编码，常见有以下格式
  xml   : 如 webservie soap
  json  : 如 JSON-RPC
  binary: 如 thrift; hession; kryo 等
  
  ```

  序列化

  - 序列化和反序列化的效率，越快越好
  - 序列化后的字节长度，越小越好
  - 序列化和反序列化的兼容性，接口参数对象若增加了字段，是否兼容

- RpcConnector
  负责维护客户方和服务方的连接通道

- RpcAcceptor
  负责接收客户方请求并返回请求结果

- RpcProcessor
  负责在服务方控制调用过程，包括管理调用线程池、超时间等

- RpcChannel
  数据传输通道

#### RPC实现

- 远程接口与客户端代理

- 解码

- 服务

- 执行调用

- RPC 异常处理



